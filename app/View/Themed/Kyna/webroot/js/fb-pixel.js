/**
 * Created by tn on 12/02/2016.
 */
<!-- Facebook Pixel Code -->
'use strict'
/**
 Pages
 - Trang chủ: k-highlights, key: homepage
 - Trang cate: k-listing, key: category
 - Trang subcate
 - Trang Search result
 - Trang detail page (Course relevant): k-detail
 */
function FBPIXEL(){this.init()}FBPIXEL.prototype={homePage:"Homepage",categoryPage:"Category",subCategoryPage:"Sub Category",searchPage:"Search Result",detailRelevantPage:"Detail - Course Relevant",cartPage:"Cart Page",checkoutPage:"Checkout Page",purchasePage:"Purchase Page",otherPage:"Other Page",tagPage:"Tag Page",init:function(){this.initDataLayer()},initDetailImpression:function(t){var e=null;switch(t){case this.detailRelevantPage:var a=$(".k-course-details-header, .k-combo-details-header"),i=a.attr("data-id"),n=a.attr("data-course-type"),r=this.deCurrency(a.find(".price-list>ul>li:first").text().trim());"Miễn phí"===r&&(r=0),1!=n&&2!=n&&3!=n||(e={content_ids:[i],content_type:"product",value:r,currency:"VND"})}e&&this.insertDataDetailImpression(e)},initAddToCart:function(t){var e=this;switch(t){case e.homePage:case e.searchPage:case e.categoryPage:case e.subCategoryPage:var a=$(".k-popup-lesson");$("body").on("click",".add-to-cart",function(t){var i=a.find(".modal-body").attr("data-id"),n=e.deCurrency(a.find("ul.k-popup-lesson-detail-price>li:first>span.bold").text().trim());if("Miễn phí"!==n){var r={content_ids:[i],content_type:"product",value:n,currency:"VND"};e.insertDataAddToCart(r)}});break;case e.detailRelevantPage:var i=(a=$(".k-course-details-header, .k-combo-details-header")).attr("data-id");a.find(".add-to-cart").click(function(){var t=e.deCurrency(a.find(".price-list>ul>li:first").text().trim());if("Miễn phí"!==t){var n={content_ids:[i],content_type:"product",value:t,currency:"VND"};e.insertDataAddToCart(n)}})}},initPurchase:function(t){var e=this;switch(t){case e.purchasePage:var a=$("#checkout-succ-online");if(a.find(".checkout-succ-title").length>0){var i=a.find(".checkout-list-price"),n=e.deCurrency(i.find(">ul>li:last>span.price").text().trim());if(n>0){var r={content_ids:[],contents:[],content_type:"product",value:n,currency:"VND"};a.find("ul.list>li").each(function(t){var a=$(this).attr("data-id"),i=$(this).attr("data-course-type"),n=e.deCurrency($(this).find(".price:first").text().trim());1!=i&&3!=i||(r.content_ids.push(a),"Miễn phí"===n&&(n=0),r.contents.push({id:a,item_price:n,quantity:1}))}),r.content_ids.length>0&&e.insertDataPurchase(r)}}}},initCheckout:function(t){var e=this;switch(t){case e.checkoutPage:var a=$(".wrap-content-right"),i=a.find(".checkout-list-price"),n={content_ids:[],contents:[],content_type:"product",value:e.deCurrency(i.find(">ul>li:last>span.price").text().trim()),currency:"VND"};a.find("ul.list>li").each(function(t){var a=$(this).attr("data-id"),i=$(this).attr("data-course-type"),r=e.deCurrency($(this).find(".price:first").text().trim());1!=i&&3!=i||(n.content_ids.push(a),"Miễn phí"===r&&(r=0),n.contents.push({id:a,item_price:r,quantity:1}))}),n.content_ids.length>0&&e.insertDataCheckout(n)}},initCategory:function(t){switch(t){case this.homePage:var e={content_type:"product",content_name:"HomePage",content_ids:[],contents:[],currency:"VND",value:0};if((i=this.crawlPage("homePage")).products.length>0)for(var a=0;a<i.products.length;a++){if(1!=(n=i.products[a]).type&&2!=n.type&&3!=n.type||(e.content_ids.push(n.id),e.contents.push({id:n.id,quantity:1,item_price:n.price})),e.contents.length>9)break}e.content_ids.length>0&&this.insertDataCategory(e);break;case this.categoryPage:case this.subCategoryPage:var i;e={content_type:"product",content_name:"CategoryPage",content_ids:[],contents:[],currency:"VND"};if((i=this.crawlPage("categoryPage")).products.length>0)for(a=0;a<i.products.length;a++){var n;if(1!=(n=i.products[a]).type&&2!=n.type&&3!=n.type||(e.content_ids.push(n.id),e.contents.push({id:n.id,quantity:1,item_price:n.price})),e.contents.length>9)break}e.content_ids.length>0&&this.insertDataCategory(e);break;case this.searchPage:}},initTag:function(t){switch(t){case this.tagPage:var e={content_type:"product",content_name:"TagPage",content_ids:[],contents:[],currency:"VND"},a=this.crawlPage("categoryPage");if(a.products.length>0)for(var i=0;i<a.products.length;i++){var n=a.products[i];if(1!=n.type&&2!=n.type&&3!=n.type||(e.content_ids.push(n.id),e.contents.push({id:n.id,quantity:1,item_price:n.price})),e.contents.length>9)break}e.content_ids.length>0&&this.insertTagPage(e)}},initSearch:function(t){var e={content_type:"product",search_string:new URL(window.location.href).searchParams.get("q"),currency:"VND",content_ids:[],contents:[]},a=this.crawlPage("categoryPage");if(a.products.length>0)for(var i=0;i<a.products.length;i++){var n=a.products[i];if(1!=n.type&&2!=n.type&&3!=n.type||(e.content_ids.push(n.id),e.contents.push({id:n.id,quantity:1,item_price:n.price})),e.contents.length>9)break}e.content_ids.length>0&&this.insertDataSearch(e)},insertDataDetailImpression:function(t){fbq("track","ViewContent",t)},insertDataAddToCart:function(t){fbq("track","AddToCart",t)},insertDataPurchase:function(t){fbq("track","Purchase",t)},insertDataCategory:function(t){fbq("track","ViewCategory",t)},insertDataSearch:function(t){fbq("track","Search",t)},insertDataCheckout:function(t){fbq("track","InitiateCheckout",t)},insertTagPage:function(t){fbq("track","ViewTags",t)},initDataLayer:function(){var t=window.location.pathname,e=window.location.href,a=new URL(e).searchParams.get("q"),i=new RegExp(/[a-z0-9-]+/g),n=t.match(i);null===n?this.initAddToCart(this.homePage):n.length>0&&"gio-hang"===n[0]||(n.length>0&&"thanh-toan"===n[0]&&"thanh-cong"===n[1]?this.initPurchase(this.purchasePage):n.length>0&&"thanh-toan"===n[0]?this.initCheckout(this.checkoutPage):n.length>0&&"tag"===n[0]?this.initTag(this.tagPage):n.length>0&&(""===a||null===a)&&$(".k-course-details-related").length>0?(this.initDetailImpression(this.detailRelevantPage),this.initAddToCart(this.detailRelevantPage)):n.length<3&&(""===a||null===a)&&$("#k-listing").length>0?(this.initCategory(this.categoryPage),this.initAddToCart(this.categoryPage)):n.length>=3&&(""===a||null===a)&&$("#k-listing").length>0?(this.initCategory(this.categoryPage),this.initAddToCart(this.categoryPage)):n.length>0&&""!==a&&null!==a&&$("#k-listing").length>0&&(this.initSearch(),this.initAddToCart(this.searchPage)))},deCurrency:function(t){var e=t.match(/[\d\,\.]+/g);return e?e[0].replace(/,/g,".").replace(/\s/g,"").replace(/\./g,""):t},deUrl:function(t){return t.replace(/\-p[0-9]{1,}.*/g,"")},crawlPage:function(t){var e=this;switch(t){case"homePage":var a={products:[]};return(i=$("#k-highlights").find("> ul.k-box-card-list > li.k-box-card")).length>0&&i.each(function(t,i){var n={};n.raw=i,n.id=$(i).find(".k-box-card-wrap").attr("data-id"),n.type=$(i).find(".k-box-card-wrap").attr("data-course-type"),n.price=e.deCurrency($(i).find(".k-box-card-wrap div.view-price li.price").text().trim()),"Miễn phí"==n.price&&(n.price=0),n.href=$(i).find("> a.card-popup").attr("href"),a.products.push(n)}),a;case"categoryPage":case"searchPage":var i;a={products:[]};return(i=$("#k-listing").find("ul.k-box-card-list li.k-box-card")).length>0&&i.each(function(t,i){var n={};n.raw=i,n.id=$(i).find(".k-box-card-wrap").attr("data-id"),n.type=$(i).find(".k-box-card-wrap").attr("data-course-type"),n.price=e.deCurrency($(i).find(".k-box-card-wrap div.view-price li.price").text().trim()),"Miễn phí"==n.price&&(n.price=0),n.href=$(i).find("> a.card-popup").attr("href"),a.products.push(n)}),a;default:return null}}};
